<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œê·¸ì¸ | íšŒì›ê°€ì…</title>
    
    <!-- 1. Firebase SDK ë¡œë“œ (ê°€ì¥ ê¸°ë³¸ ë²„ì „) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    
    <!-- 2. jQuery (Firebaseì™€ í˜¸í™˜ì„± ì¢‹ìŒ) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§Œ ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover { background: #0056b3; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #eee;
            border: none;
            cursor: pointer;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .form-panel { display: none; }
        .form-panel.active { display: block; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
            <button class="tab active" data-tab="login">ë¡œê·¸ì¸</button>
            <button class="tab" data-tab="signup">íšŒì›ê°€ì…</button>
        </div>
        
        <!-- ë¡œê·¸ì¸ í¼ -->
        <div id="login-form" class="form-panel active">
            <h2>ë¡œê·¸ì¸</h2>
            <div id="login-status" class="status"></div>
            <div class="input-group">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="login-email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button onclick="handleLogin()">ë¡œê·¸ì¸</button>
        </div>
        
        <!-- íšŒì›ê°€ì… í¼ -->
        <div id="signup-form" class="form-panel">
            <h2>íšŒì›ê°€ì…</h2>
            <div id="signup-status" class="status"></div>
            <div class="input-group">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="signup-email" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="signup-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="signup-confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button onclick="handleSignup()">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <script>
        // ========== Firebase ì„¤ì • ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC1XDqgki7lKMz-EE4ZFzOLmku8EsLI0yI",
            authDomain: "login-57c14.firebaseapp.com",
            projectId: "login-57c14",
            storageBucket: "login-57c14.firebasestorage.app",
            messagingSenderId: "847658526472",
            appId: "1:847658526472:web:05adaddfea3afff8e12ebd"
        };
        
        // ========== ì „ì—­ ë³€ìˆ˜ ==========
        let auth = null;
        let db = null;
        
        // ========== í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ==========
        $(document).ready(function() {
            console.log("í˜ì´ì§€ ë¡œë“œ ì‹œì‘");
            
            // 1. Firebase SDK ë¡œë“œ í™•ì¸
            console.log("Firebase ê°ì²´:", typeof firebase);
            
            if (typeof firebase === 'undefined') {
                showError('signup', 'Firebase SDKë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // 2. Firebase ì´ˆê¸°í™”
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log("âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ");
                console.log("Auth ê°ì²´:", auth);
                console.log("Firestore ê°ì²´:", db);
                
                showSuccess('login', 'ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error("âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showError('login', 'Firebase ì—°ê²° ì‹¤íŒ¨: ' + error.message);
            }
            
            // 3. íƒ­ ì „í™˜ ì´ë²¤íŠ¸
            $('.tab').click(function() {
                const tabName = $(this).data('tab');
                showTab(tabName);
            });
            
            // 4. ì—”í„° í‚¤ ì´ë²¤íŠ¸
            $('input').keypress(function(e) {
                if(e.which === 13) { // Enter í‚¤
                    const activeTab = $('.form-panel.active').attr('id');
                    if(activeTab === 'login-form') handleLogin();
                    if(activeTab === 'signup-form') handleSignup();
                }
            });
            
            console.log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ");
        });
        
        // ========== UI í•¨ìˆ˜ ==========
        function showTab(tabName) {
            // íƒ­ ë²„íŠ¼
            $('.tab').removeClass('active');
            $(`.tab[data-tab="${tabName}"]`).addClass('active');
            
            // í¼ íŒ¨ë„
            $('.form-panel').removeClass('active');
            $(`#${tabName}-form`).addClass('active');
            
            // ìƒíƒœ ë©”ì‹œì§€ ì´ˆê¸°í™”
            $(`.status`).hide();
        }
        
        function showStatus(form, message, type) {
            const statusEl = $(`#${form}-status`);
            statusEl.removeClass('success error').addClass(type);
            statusEl.text(message).show();
        }
        
        function showSuccess(form, message) {
            showStatus(form, message, 'success');
        }
        
        function showError(form, message) {
            showStatus(form, message, 'error');
        }
        
        // ========== íšŒì›ê°€ì… í•¨ìˆ˜ ==========
        async function handleSignup() {
            console.log("íšŒì›ê°€ì… ì‹œì‘");
            
            // ê°’ ê°€ì ¸ì˜¤ê¸°
            const email = $('#signup-email').val().trim();
            const name = $('#signup-name').val().trim();
            const password = $('#signup-password').val();
            const confirm = $('#signup-confirm').val();
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if(!email || !name || !password || !confirm) {
                showError('signup', 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if(password !== confirm) {
                showError('signup', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if(password.length < 6) {
                showError('signup', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // Firebase ê°ì²´ í™•ì¸
            if(!auth || !db) {
                showError('signup', 'Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const btn = $('button[onclick="handleSignup()"]');
            btn.prop('disabled', true).text('ì²˜ë¦¬ ì¤‘...');
            
            try {
                console.log("Firebase Auth ìƒì„± ì‹œë„:", email);
                
                // 1. Firebase Authì— ì‚¬ìš©ì ìƒì„±
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log("âœ… Auth ìƒì„± ì„±ê³µ:", user.uid);
                
                // 2. Firestoreì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥
                const userData = {
                    uid: user.uid,
                    email: email,
                    displayName: name,
                    tier: 'bronze',
                    points: 1000,
                    status: 'active',
                    signupMethod: 'email',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('ashop_users').doc(user.uid).set(userData);
                console.log("âœ… Firestore ì €ì¥ ì™„ë£Œ");
                
                // 3. ì„±ê³µ ì²˜ë¦¬
                showSuccess('signup', `ğŸ‰ ${name}ë‹˜, íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                // 4. í¼ ì´ˆê¸°í™”
                $('#signup-email, #signup-name, #signup-password, #signup-confirm').val('');
                
                // 5. 2ì´ˆ í›„ ë¡œê·¸ì¸ íƒ­ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    showTab('login');
                    $('#login-email').val(email);
                    showSuccess('login', `${name}ë‹˜, ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!`);
                }, 2000);
                
            } catch (error) {
                console.error("âŒ íšŒì›ê°€ì… ì‹¤íŒ¨:", error);
                
                let errorMsg = 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if(error.code === 'auth/email-already-in-use') {
                    errorMsg = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                } else if(error.code === 'auth/weak-password') {
                    errorMsg = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤.';
                }
                
                showError('signup', errorMsg);
                
            } finally {
                // ë²„íŠ¼ ë³µì›
                btn.prop('disabled', false).text('íšŒì›ê°€ì…');
            }
        }
        
        // ========== ë¡œê·¸ì¸ í•¨ìˆ˜ ==========
        async function handleLogin() {
            console.log("ë¡œê·¸ì¸ ì‹œì‘");
            
            const email = $('#login-email').val().trim();
            const password = $('#login-password').val();
            
            if(!email || !password) {
                showError('login', 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if(!auth) {
                showError('login', 'Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const btn = $('button[onclick="handleLogin()"]');
            btn.prop('disabled', true).text('ë¡œê·¸ì¸ ì¤‘...');
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ:", userCredential.user.uid);
                
                // Firestore ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
                if(db) {
                    try {
                        await db.collection('ashop_users').doc(userCredential.user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch(e) {
                        console.error("ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
                    }
                }
                
                showSuccess('login', `${email}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
                
                // 2ì´ˆ í›„ í™ˆí˜ì´ì§€ë¡œ ì´ë™ (ashop í™ˆí˜ì´ì§€)
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                
            } catch (error) {
                console.error("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                
                let errorMsg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if(error.code === 'auth/user-not-found') {
                    errorMsg = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                } else if(error.code === 'auth/wrong-password') {
                    errorMsg = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                }
                
                showError('login', errorMsg);
                
            } finally {
                btn.prop('disabled', false).text('ë¡œê·¸ì¸');
            }
        }
        
        // ========== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ==========
        function testFirebaseConnection() {
            console.log("=== Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ===");
            console.log("1. firebase ê°ì²´:", typeof firebase);
            console.log("2. firebase.apps:", firebase.apps ? firebase.apps.length : "ì—†ìŒ");
            
            if(typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                alert("âœ… Firebase ì—°ê²° ì„±ê³µ!\nì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
            } else {
                alert("âŒ Firebase ì—°ê²° ì‹¤íŒ¨!\nì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }
    </script>
</body>
</html>
